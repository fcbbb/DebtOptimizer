<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>债务优化管理系统</title>
    <link href="/static/css/bootstrap/bootstrap.min.css?v=1.0" rel="stylesheet">
    <link rel="stylesheet" href="/static/icons/bootstrap-icons.css?v=1.0">
    <link rel="stylesheet" href="/static/css/modern_style.css?v=1.0">
    <link rel="stylesheet" href="/static/css/style.css?v=1.0">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico?v=1.0">
</head>
<body class="{% block page_class %}{% endblock %}">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">债务优化管理系统</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/">首页</a>
                <a class="nav-link" href="/core/customers/">客户列表</a>
                <a class="nav-link" href="{% url 'core:company_list' %}">公司管理</a>
                <a class="nav-link" href="/core/calendar/">还款日历</a>
                <a class="nav-link" href="{% url 'core:customer_service_phone_list' %}">客服电话</a>
                <a class="nav-link" href="/admin/">后台管理</a>
                 <!-- AI代理任务按钮 -->
                <a class="nav-link" href="#" onclick="toggleAiChat()">AI助手</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid my-4">
        <div class="row">
            <!-- 左侧边栏 - 公司选择 -->
            <div class="col-md-2">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title">选择公司</h5>
                    </div>
                    <div class="card-body p-2">
                        <a href="{% url 'core:select_company' %}?company_id=" class="d-block w-100 mb-2 btn {% if not selected_company_id %}btn-primary{% else %}btn-outline-primary{% endif %}">
                            全部公司
                        </a>
                        {% for company in companies %}
                            <a href="{% url 'core:select_company' %}?company_id={{ company.id }}" class="d-block w-100 mb-2 btn {% if selected_company_id == company.id %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                {{ company.name }}
                            </a>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- 右侧主内容区 -->
            <div class="col-md-10" style="position: relative;">
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}

                {% block content %}{% endblock %}
            </div>        
        
        </div>
    </div>

    <!-- AI聊天弹窗容器 -->
    <div id="ai-chat-popup" style="position: fixed; right: -500px; width: 400px; z-index: 1000; transition: right 0.3s ease; display: flex; flex-direction: column;">
            {% include 'ai_chat.html' %}
    </div>
    
    <!-- 返回顶部按钮 -->
    <div id="backToTop" style="position: fixed; left: 20px; bottom: 20px; display: none; z-index: 999;">
        <button class="btn btn-primary rounded-pill px-3 py-2 shadow" type="button" title="返回顶部" style="transition: all 0.3s ease; font-size: 0.875rem;">
            <i class="bi bi-arrow-up"></i> 返回顶部
        </button>
    </div>

    <script src="/static/js/bootstrap/bootstrap.bundle.min.js"></script>
    <!-- 使用Bootstrap Icons替代FontAwesome以避免CORS问题 -->
    <link rel="stylesheet" href="/static/icons/bootstrap-icons.css">
    <script src="/static/js/modern_scripts.js"></script>
    {% block script %}{% endblock %}
    
    <script>
        // AI聊天弹窗控制函数
        function toggleAiChat() {
            var popup = document.getElementById('ai-chat-popup');
            if (popup.style.right === '0px') {
                popup.style.right = '-500px';
            } else {
                popup.style.right = '0px';
            }
        }
        
        // 点击弹窗外的区域关闭弹窗
        document.addEventListener('click', function(event) {
            var popup = document.getElementById('ai-chat-popup');
            var isClickInsidePopup = popup.contains(event.target);
            var isClickOnNav = event.target.closest('.nav-link') && event.target.textContent.includes('AI助手');
            
            // 如果点击的是导航栏中的AI助手链接，则不处理（由toggleAiChat处理）
            if (isClickOnNav) return;
            
            // 如果点击的是弹窗外的区域，则关闭弹窗
            if (!isClickInsidePopup && popup.style.right === '0px') {
                popup.style.right = '-500px';
            }
        });
        
        // 返回顶部按钮功能
        document.addEventListener('DOMContentLoaded', function() {
            const backToTopButton = document.getElementById('backToTop');
            if (backToTopButton) {
                // 滚动时显示/隐藏返回顶部按钮
                window.addEventListener('scroll', function() {
                    if (window.pageYOffset > 300) {
                        backToTopButton.style.display = 'block';
                    } else {
                        backToTopButton.style.display = 'none';
                    }
                });
                
                // 点击返回顶部按钮时平滑滚动到顶部
                backToTopButton.addEventListener('click', function() {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                });
            }
        });
    </script>
</body>
</html>