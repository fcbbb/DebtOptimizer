{% extends 'base.html' %}
{% load custom_filters %}
{% block page_class %}home-page{% endblock %}
{% block content %}
<input type="hidden" id="show_celebration_flag" value="{{ show_celebration }}">
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
<div class="row">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">ğŸ“… éœ€è¿˜æ¬¾å®¢æˆ·æé†’</h5>
            </div>
            <div class="card-body">
                {% if tasks_completed %}
                    <div class="alert alert-success text-center">
                        <h4 class="mb-0">æ­å–œä½ ï¼Œä»Šå¤©çš„ä»»åŠ¡éƒ½å®Œæˆå•¦ï¼</h4>
                    </div>
                {% elif due_customers %}
                    <div class="alert alert-warning">
                        <strong>ğŸ”” {{ today_date }} æœ‰ {{ due_customers|length }} ä½å®¢æˆ·éœ€è¦å¤„ç†è¿˜æ¬¾ï¼š</strong>
                        <div class="container-fluid">
                            <div class="row">
                                {% for customer in due_customers %}
                                <div class="col-md-4 col-sm-6 col-12 mb-2">
                                    <div class="customer-item">
                                        <div class="customer-info" style="display: flex; align-items: center; gap: 8px; flex-wrap: nowrap; height: 100%;">
                                            <a href="{% url 'core:customer_detail' customer.id %}" style="white-space: nowrap; flex-grow: 1;">
                                                <strong>{{ customer.name }}</strong> - {{ customer.phone }}
                                            </a>
                                            <!-- åªæœ‰åœ¨é€‰æ‹©äº†å…¬å¸åæ‰æ˜¾ç¤ºæ“ä½œæŒ‰é’® -->
                                            {% if selected_company_id %}
                                            <button type="button" 
                                                    class="btn btn-sm homepage-complete-btn toggle-status-btn {% if customer.id in completed_customers %}btn-success{% else %}btn-secondary{% endif %}"
                                                    data-customer-id="{{ customer.id }}"
                                                    data-csrf="{{ csrf_token }}"
                                                    style="margin-left: 5px; margin-right: 5px; flex-shrink: 0;">
                                                {% if customer.id in completed_customers %}å·²å®Œæˆ{% else %}æ ‡è®°å®Œæˆ{% endif %}
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% if forloop.counter|divisibleby:3 and not forloop.last %}
                            </div>
                            <div class="row">
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% if tasks_completed %}
                            <button class="btn btn-success homepage-complete-btn" disabled>ä»»åŠ¡å·²å®Œæˆ</button>
                        {% endif %}
                    </div>
                {% else %}
                    <p class="text-success">ğŸ‰ æ˜å¤©æ²¡æœ‰éœ€è¦è¿˜æ¬¾çš„å®¢æˆ·ï¼Œä¸€åˆ‡é¡ºåˆ©ï¼</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">ğŸ“… èèµ„æ—¥æœŸæé†’</h5>
            </div>
            <div class="card-body">
                {% if financing_reminder_customers %}
                    <div class="alert alert-warning">
                        <strong>ğŸ”” æœªæ¥70å¤©å†…æœ‰ {{ financing_reminder_customers|length }} ä½å®¢æˆ·èèµ„æ—¥æœŸåˆ°æœŸï¼š</strong>
                        <ul class="mb-3">
                            {% for customer in financing_reminder_customers %}
                            <li class="customer-item mb-2">
                                <div class="customer-info">
                                    <a href="{% url 'core:customer_detail' customer.id %}">
                                        <strong>{{ customer.name }}</strong> - {{ customer.phone }}
                                    </a>
                                    <span class="ms-2 badge bg-warning text-dark">
                                        å‰©ä½™ {{ customer.days_until_financing.days }} å¤©
                                    </span>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% else %}
                    <p class="text-success">ğŸ‰ æš‚æ— éœ€è¦æé†’çš„èèµ„å®¢æˆ·</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0">ğŸ“‹ ç­¾çº¦æ—¥æœŸæé†’</h5>
                </div>
                <div class="card-body">
                    {% if contract_reminder_customers and not contract_reminder_completed %}
                        <div class="alert alert-danger contract-reminders-section">
                            <strong>ğŸ”” æœ‰ {{ contract_reminder_customers|length }} ä½å®¢æˆ·éœ€è¦å¤„ç†ç­¾çº¦æ—¥æœŸæé†’ï¼š</strong>
                            <ul class="mb-3">
                                {% for customer in contract_reminder_customers %}
                                <li class="customer-item mb-2">
                                    <div class="customer-info">
                                    <a href="{% url 'core:customer_detail' customer.id %}">
                                        <strong>{{ customer.name }}</strong> - {{ customer.phone }}
                                    </a>
                                    <span class="ms-2 badge bg-danger text-white">
                                        å·²ç­¾çº¦ {{ customer.days_since_contract }} å¤©
                                    </span>
                                    <span class="ms-2 badge bg-info text-white">
                                        ç¬¬{{ customer.reminder_count }}æ¬¡æé†’
                                    </span>
                                    <span class="ms-2 badge bg-primary text-white">
                                        ä¸‹æ¬¡: {{ customer.next_reminder_date|date:'Y-m-d' }}
                                    </span>
                                    {% if selected_company_id %}
                                    <button type="button" 
                                            class="btn btn-sm homepage-complete-btn contract-reminder-btn {% if customer.id in completed_contract_customers %}btn-success{% else %}btn-secondary{% endif %}"
                                            data-customer-id="{{ customer.id }}"
                                            data-csrf="{{ csrf_token }}">
                                        {% if customer.id in completed_contract_customers %}å·²å¤„ç†{% else %}æ ‡è®°å·²å¤„ç†{% endif %}
                                    </button>
                                    {% endif %}
                                </div>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% elif contract_reminder_customers and contract_reminder_completed %}
                        <p class="text-success">ğŸ‰ æ‰€æœ‰ç­¾çº¦æé†’å·²å¤„ç†å®Œæˆï¼</p>
                    {% else %}
                        <p class="text-success">ğŸ‰ æš‚æ— éœ€è¦å¤„ç†çš„ç­¾çº¦æé†’</p>
                    {% endif %}
                </div>
            </div>
        </div>
</div>

<div class="row">
    <div class="col-md-3">
        <div class="card text-white bg-primary mb-3">
            <div class="card-body">
                <h5 class="card-title">ğŸ‘¥ æ€»å®¢æˆ·æ•°</h5>
                <p class="card-text display-6">{{ total_customers }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success mb-3">
            <div class="card-body">
                <h5 class="card-title">ğŸ’° æœˆä¾›æ€»é¢</h5>
                <p class="card-text display-6">Â¥{{ total_monthly_payment|floatformat:2 }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning mb-3">
            <div class="card-body">
                <h5 class="card-title">ğŸ’³ æ€»è´Ÿå€º</h5>
                <p class="card-text display-6">Â¥{{ total_debt_limit|floatformat:2 }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-danger mb-3">
            <div class="card-body">
                <h5 class="card-title">ğŸ’¸ æ€»å‡ºæ¬¾</h5>
                <p class="card-text display-6">Â¥{{ total_payment|floatformat:2 }}</p>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <a href="{% url 'core:customer_list' %}" class="btn btn-lg btn-outline-primary w-100 mb-3">
            <i class="fas fa-users"></i> æŸ¥çœ‹æ‰€æœ‰å®¢æˆ·
        </a>
    </div>
    <div class="col-md-6">
        <a href="{% url 'core:calendar' %}" class="btn btn-lg btn-outline-info w-100 mb-3">
            <i class="fas fa-calendar-alt"></i> æŸ¥çœ‹è¿˜æ¬¾æ—¥å†
        </a>
    </div>
</div>

{% endblock %}